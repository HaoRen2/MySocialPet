@model MySocialPet.Models.ViewModel.Albums.DetailAlbumViewModel
@{
    var mascotasUsuario = ViewBag.MascotasUsuario;
    ViewData["Title"] = "Detalles Álbum";
}

<div class="container pt-nav mb-5">
    <div class="card shadow-lg border-0 mb-4">
        <div class="card-header bg-lightgreen text-white d-flex justify-content-between align-items-center">
            <a href="@Url.Action("ListAlbum", "Albums")" class="btn btn-light btn-sm text-white me-3" title="Volver a mis álbumes">
                <i class="bi bi-arrow-left text-white"></i> Volver
            </a>
            <h4 class="mb-0 flex-grow-1 text-center">@Model.NombreAlbum</h4>
            <span class="badge bg-light text-dark ms-3">@Model.TotalFotos fotos</span>
        </div>

        <div class="card-body">
            <div class="row g-4">
                @if (Model.FotosDeLaPagina != null && Model.FotosDeLaPagina.Any())
                {
                    foreach (var foto in Model.FotosDeLaPagina)
                    {
                        var base64Image = Convert.ToBase64String(foto.Foto);
                        var imgSrc = $"data:image/png;base64,{base64Image}";
                        var taggedPets = foto.MascotasEtiquetadas != null && foto.MascotasEtiquetadas.Any()
                        ? string.Join(", ", foto.MascotasEtiquetadas.Where(m => m.Mascota != null).Select(m => m.Mascota.Nombre))
                        : "Ninguna";

                        <div class="col-md-3">
                            <div class="card shadow-sm border-0 overflow-hidden" style="transition: transform 0.3s;">
                             <div data-fancybox="gallery"
                                     data-src="@imgSrc"
                                data-caption=" 
                   <h5>@Html.Raw(System.Text.Encodings.Web.JavaScriptEncoder.Default.Encode(foto.Titulo ?? ""))</h5>
                   <p>@Html.Raw(System.Text.Encodings.Web.JavaScriptEncoder.Default.Encode(foto.Descripcion ?? ""))</p>
                   <p><strong>Fecha:</strong> @foto.Fecha.ToString("dd/MM/yyyy")</p>
                   <p><strong>Mascotas:</strong> @Html.Raw(System.Text.Encodings.Web.JavaScriptEncoder.Default.Encode(taggedPets))</p>
                   <div class='d-flex justify-content-center mt-2'>
                       <a href='@Url.Action("EditarFoto", "Albums", new { idFoto = foto.IdFoto })'
                          class='btn btn-outline-light me-2' title='Editar foto'>
                           <i class='bi bi-pencil-square'></i>
                       </a>
                       <form method='post'
                             class='delete-photo-form'
                             style='display: inline;'
                             data-idfoto='@foto.IdFoto'
                             data-delete-url='@Url.Action("DeleteFoto", "Albums")'>
                           <button type='submit' title='Eliminar foto' class='btn btn-outline-danger'>
                               <i class='bi bi-trash'></i>
                           </button>
                       </form>
                   </div>
               </div>">
                                              
                                    <img src="@imgSrc"
                                         class="card-img-top"
                                         alt="@foto.Titulo"
                                         style="height: 200px; object-fit: cover; cursor: pointer; transition: opacity 0.3s;">
                                </div>

                                <div class="card-body text-center p-2">
                                    <h6 class="card-title mb-0">@foto.Titulo</h6>
                                </div>
                            </div>
                        </div>

                    }
                    @Html.AntiForgeryToken()
                }
                else
                {
                    <div class="col-12 text-center">
                        <p class="text-muted">No hay fotos en este álbum aún. ¡Agrega algunas!</p>
                    </div>
                }
            </div>

            @if (Model.TotalPaginas > 1)
            {
                <nav aria-label="Navegación de fotos" class="mt-5 d-flex justify-content-center">
                    <ul class="pagination">
                        <li class="page-item @(Model.TienePaginaAnterior ? "" : "disabled")">
                            <a class="page-link text-black bg-lightgreen" asp-action="DetailsAlbum" asp-route-idAlbum="@Model.IdAlbum" asp-route-pagina="@(Model.PaginaActual - 1)">Anterior</a>
                        </li>
                        @for (int i = 1; i <= Model.TotalPaginas; i++)
                        {
                            <li class="page-item @(i == Model.PaginaActual ? "active" : "")">
                                <a class="page-link text-black bg-lightgreen @(i == Model.PaginaActual ? "bg-success text-black" : "bg-light")" asp-controller="DetailsAlbum" asp-action="@Model.IdAlbum" asp-route-pagina="@i">@i</a>
                            </li>
                        }
                        <li class="page-item @(Model.TienePaginaSiguiente ? "" : "disabled")">
                            <a class="page-link text-black bg-lightgreen" asp-action="DetailsAlbum" asp-route-idAlbum="@Model.IdAlbum" asp-route-pagina="@(Model.PaginaActual + 1)">Siguiente</a>
                        </li>
                    </ul>
                </nav>
            }
        </div>
    </div>
</div>



<!-- Botón flotante y Modal (sin cambios) -->
<button class="btn btn-verde rounded-circle shadow-lg"
        style="position: fixed; bottom: 40px; right: 50px; width: 60px; height: 60px; font-size: 28px; line-height: 1; box-shadow: 0 0 20px rgba(0,0,0,0.875);"
        data-bs-toggle="modal" data-bs-target="#modalInsertarFoto">
    +
</button>

<div class="modal fade" id="modalInsertarFoto" tabindex="-1" aria-labelledby="modalInsertarFotoLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="InsertarFoto" asp-controller="Albums" method="post" enctype="multipart/form-data">
                @Html.AntiForgeryToken()
                <input type="hidden" name="IdAlbum" value="@Model.IdAlbum" />
                <div class="modal-header">
                    <h5 class="modal-title" id="modalInsertarFotoLabel">Agregar Foto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Título</label>
                        <input type="text" name="Titulo" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Foto</label>
                        <input type="file" name="Foto" class="form-control" accept="image/*" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descripción</label>
                        <textarea name="Descripcion" class="form-control" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Fecha</label>
                        <input type="date" name="Fecha" class="form-control" required />
                    </div>
                    @if (mascotasUsuario != null)
                    {
                        <div class="mb-3">
                            <label class="form-label">Mascotas Etiquetadas</label>
                            <div>
                                @foreach (var mascota in mascotasUsuario)
                                {
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" name="MascotasEtiquetadasIds" value="@mascota.Value" id="mascota_@mascota.Value" />
                                        <label class="form-check-label" for="mascota_@mascota.Value">@mascota.Text</label>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Subir Foto</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .fancybox-caption {
        text-align: center;
        padding: 20px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
    }

    .custom-caption h5, .custom-caption p {
        margin-bottom: 5px;
    }
</style>


@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

 <script>
        document.addEventListener('DOMContentLoaded', function () {

            Fancybox.bind("[data-fancybox='gallery']", {
            });

            document.addEventListener('submit', function (event) {
                if (event.target.matches('.delete-photo-form')) {
                    event.preventDefault(); 

                    const form = event.target; 

                    if (confirm('¿Seguro que deseas eliminar esta foto?')) {
                        const idFoto = form.getAttribute('data-idfoto');
                        const deleteUrl = form.getAttribute('data-delete-url');
                        const antiForgeryToken = document.querySelector('input[name="__RequestVerificationToken"]').value;

                        fetch(deleteUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                                'RequestVerificationToken': antiForgeryToken
                            },
                            body: `idFoto=${idFoto}` // Enviamos como form-urlencoded
                        })
                        .then(response => {
                            if (response.ok) {
                                // Para una mejor experiencia, es bueno notificar antes de recargar
                                alert('Foto eliminada con éxito.');
                                window.location.reload();
                            } else {
                                // Si el servidor devuelve un error (p.ej. un 400 o 500)
                                alert('Error al eliminar la foto.');
                            }
                        })
                        .catch(error => {
                            console.error('Error de red:', error);
                            alert('Error de red al eliminar la foto.');
                        });
                    }
                }
            });
        });
    </script>
}
}