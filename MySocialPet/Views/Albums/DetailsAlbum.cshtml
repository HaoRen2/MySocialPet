@model MySocialPet.Models.ViewModel.Albums.DetailAlbumViewModel
@{
    var mascotasUsuario = ViewBag.MascotasUsuario;
    ViewData["Title"] = "Detalles Álbum";
    var albumName = Model.DetailAlbum.NombreAlbum;
}

<div class="container mt-5">
    <div class="card shadow-lg border-0 mb-4">
        <div class="card-header bg-lightgreen text-white d-flex justify-content-between align-items-center">
            <!-- Botón de Volver a la lista de álbumes -->
            <a href="@Url.Action("ListAlbum", "Albums")" class="btn btn-light btn-sm text-white me-3" title="Volver a mis álbumes">
                <i class="bi bi-arrow-left text-white"></i> Volver
            </a>
            <h4 class="mb-0 flex-grow-1 text-center">@albumName</h4>
            <span class="badge bg-light text-dark ms-3">@Model.DetailAlbum.Fotos.Count() fotos</span>
        </div>

        <div class="card-body">
            <div class="row g-4">
                @if (Model.DetailAlbum.Fotos != null && Model.DetailAlbum.Fotos.Any())
                {
                    foreach (var foto in Model.DetailAlbum.Fotos)
                    {
                        var base64Image = Convert.ToBase64String(foto.Foto);
                        var imgSrc = $"data:image/png;base64,{base64Image}";
                        var taggedPets = foto.MascotasEtiquetadas != null && foto.MascotasEtiquetadas.Any()
                        ? string.Join(", ", foto.MascotasEtiquetadas.Select(m => m.Mascota.Nombre))
                        : "Ninguna";

                        <div class="col-md-3">
                            <div class="card shadow-sm border-0 overflow-hidden" style="transition: transform 0.3s;">

                                <div data-fancybox="gallery"
                                     data-src="@imgSrc"
                                     data-caption="
                                                 <div class='custom-caption'>
                                                     <h5>@Html.Raw(System.Text.Encodings.Web.JavaScriptEncoder.Default.Encode(foto.Titulo))</h5>
                                                     <p>@Html.Raw(System.Text.Encodings.Web.JavaScriptEncoder.Default.Encode(foto.Descripcion))</p>
                                                     <p><strong>Fecha:</strong> @foto.Fecha.ToString("dd/MM/yyyy")</p>
                                                     <p><strong>Mascotas:</strong> @Html.Raw(System.Text.Encodings.Web.JavaScriptEncoder.Default.Encode(taggedPets))</p>
                                                     <div class='d-flex justify-content-center mt-2'>
                                                         <a href='@Url.Action("EditarFoto", "Albums", new { idFoto = foto.IdFoto })'
                                                         class='btn btn-outline-light me-2'
                                                         title='Editar foto'>
                                                             <i class='bi bi-pencil-square'></i>
                                                         </a>

                                                         <!-- Formulario simplificado, sin action -->
                                                         <form method='post'
                                                               class='delete-photo-form'
                                                               style='display: inline;'
                                                               data-idfoto='@foto.IdFoto'
                                                               data-delete-url='@Url.Action("DeleteFoto", "Albums")'>
                                                             <input type='hidden' name='id' value='@foto.IdFoto' />
                                                             <button type='submit' title='Eliminar foto' class='btn btn-outline-danger'>
                                                                 <i class='bi bi-trash'></i>
                                                             </button>
                                                         </form>
                                                     </div>
                                                 </div>">

                                            <img src="@imgSrc"
                                                 class="card-img-top"
                                                 alt="@foto.Titulo"
                                                 style="height: 200px; object-fit: cover; cursor: pointer; transition: opacity 0.3s;">
                                        </div>
                                <div class="card-body text-center p-2">
                                    <h6 class="card-title mb-0">@foto.Titulo</h6>
                                </div>
                            </div>
                        </div>
                    }

                    @* Este es el token que el JavaScript buscará en la página para validar la petición *@
                    @Html.AntiForgeryToken()
                }
                else
                {
                    <div class="col-12 text-center">
                        <p class="text-muted">No hay fotos en este álbum aún. ¡Agrega algunas!</p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Botón flotante -->
<button class="btn btn-verde rounded-circle shadow-lg"
        style="position: fixed; bottom: 405px; right: 50px; width: 60px; height: 60px; font-size: 28px; line-height: 1; box-shadow: 0 0 20px rgba(0,0,0,0.875);"
        data-bs-toggle="modal" data-bs-target="#modalInsertarFoto">
    +
</button>

<!-- Modal para subir foto -->
<div class="modal fade" id="modalInsertarFoto" tabindex="-1" aria-labelledby="modalInsertarFotoLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="InsertarFoto" asp-controller="Albums" method="post" enctype="multipart/form-data">
                @Html.AntiForgeryToken() @* Añadido el token AntiForgery para este formulario también *@
                <input type="hidden" name="IdAlbum" value="@Model.DetailAlbum.IdAlbum" />

                <div class="modal-header">
                    <h5 class="modal-title" id="modalInsertarFotoLabel">Agregar Foto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>

                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Título</label>
                        <input type="text" name="Titulo" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Foto</label>
                        <input type="file" name="Foto" class="form-control" accept="image/*" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Descripción</label>
                        <textarea name="Descripcion" class="form-control"></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Fecha</label>
                        <input type="date" name="Fecha" class="form-control" required />
                    </div>

                    @if (mascotasUsuario != null)
                    {
                        <div class="mb-3">
                            <label class="form-label">Mascotas Etiquetadas</label>
                            <div>
                                @foreach (var mascota in mascotasUsuario)
                                {
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox"
                                               name="MascotasEtiquetadasIds"
                                               value="@mascota.Value"
                                               id="mascota_@mascota.Value" />
                                        <label class="form-check-label" for="mascota_@mascota.Value">@mascota.Text</label>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Subir Foto</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .fancybox-caption {
        text-align: center;
        padding: 20px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
    }

    .custom-caption {
        position: relative;
    }

        .custom-caption .album-name {
            position: absolute;
            top: -50px;
            right: 20px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 1.2rem;
        }

        .custom-caption h5 {
            margin-top: 10px;
            margin-bottom: 5px;
        }

        .custom-caption p {
            margin-bottom: 5px;
        }
</style>

<script type="module" src="@Url.Content("~/js/Class.js")"></script>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        // JavaScript para manejar el borrado de fotos con confirmación
        document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('.delete-photo-form').forEach(form => {
                form.addEventListener('submit', function (event) {
                    event.preventDefault(); // Prevenir el envío normal del formulario

                    // Mostrar un cuadro de diálogo de confirmación
                    if (confirm('¿Seguro que deseas eliminar esta foto?')) {
                        const idFoto = this.getAttribute('data-idfoto');
                        const deleteUrl = this.getAttribute('data-delete-url');
                        const antiForgeryToken = document.querySelector('input[name="__RequestVerificationToken"]').value;

                        fetch(deleteUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                                'RequestVerificationToken': antiForgeryToken // Enviar el token en el header
                            },
                            body: `idFoto=${idFoto}` // Asegúrate de que el nombre del parámetro coincida con el controlador
                        })
                        .then(response => {
                            if (response.ok) {
                                // Recargar la página o eliminar el elemento de la UI
                                window.location.reload(); // Recarga simple para refrescar la lista
                            } else {
                                // Manejar errores
                                alert('Error al eliminar la foto.');
                                console.error('Error al eliminar la foto:', response.statusText);
                            }
                        })
                        .catch(error => {
                            alert('Error de red al eliminar la foto.');
                            console.error('Error de red:', error);
                        });
                    }
                });
            });
        });
    </script>
}
